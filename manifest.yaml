type: install
name: Basic Magnolia CMS
description: |
  The JPS manifest contains the following nodes:
  * Nginx
  * Tomcat 8.5
  * MariaDB 10
baseUrl: https://github.com/jdiepeveen/jelastic-jps-magnolia-cms/raw/master
logo: https://github.com/jdiepeveen/jelastic-jps-magnolia-cms/raw/master/images/view.png
engine: java8

globals:
  dbUsername: magnolia
  dbPassword: ${fn.password}
  tomcatDataPath: /data

settings:
  fields:
    - name: environment
      type: list
      caption: Environment
      required: true
      editable: true
      regex: "^[a-zA-Z0-9-]+$"
      values:
        test: test
        acceptance: acceptance
        production: production
    - name: basicAuth
      type: radio-fieldset
      caption: Authentication
      default: disabled
      values:
        enabled: Enabled authentication
        disabled: Disabled authentication
      showIf:
        enabled:
          - name: authUsername
            type: string
            caption: Username
            required: true
          - name: authPassword
            type: string
            caption: Password
            required: true

#    - name: maintenance
#      type: toggle
#      caption: Maintanance page

nodes:
  - nodeType: nginx
    cloudlets: 4
    nodeGroup: bl

  - nodeType: tomcat85
    cloudlets: 16
    nodeGroup: cp
    env:
      # Set environment and timezone variables
      CATALINA_OPTS: -Denvironment=${settings.environment} -Duser.timezone=Europe/Amsterdam
    volumes:
      - /data
    links:
      -  sqldb:db

  - nodeType: mariadb10
    cloudlets: 6
    nodeGroup: sqldb
    env:
      # Disable exposing ports to the outside
      JELASTIC_EXPOSE: DISABLED

actions:
  createMagnoliaDataDirectory:
    createDirectory [tomcat85]: ${globals.tomcatDataPath}/magnolia
  createDatabase:
    cmd [sqldb]:
      - curl -fsSL ${baseUrl}/scripts/createDb.sh | /bin/bash -s ${nodes.sqldb.password} magnolia ${globals.dbPassword}
  enableAuthentication:
    log: "## Basic authentication is enabled"
    cmd [bl]:
      - curl -fsSL ${baseUrl}/scripts/createHtaccess.sh | /bin/bash -s ${settings.authUsername} ${settings.authPassword}
      - curl -fsSL ${baseUrl}/config/nginx/conf.d/basic_auth.conf -o /etc/nginx/conf.d/basic_auth.conf
    appendFile [bl]:
      path: /etc/jelastic/redeploy.conf
      body: "/etc/nginx/conf.d/basic_auth.conf\n/etc/nginx/conf.d/password.htpasswd"
  enableMaintenance:
    log: "## Maintenance page is enabled"
    createFile [bl]:
      path: /usr/share/nginx/html/.maintenance_off

onInstall:
  - createMagnoliaDataDirectory
  - createDatabase
  - if (settings.basicAuth == 'enabled'):
    - enableAuthentication
  - if (settings.maintenance == true):
    - enableMaintenance

success:
  text: |
    #### TLDR
    * Database-url: db:3306
    * Database user: ${globals.dbUsername}
    * Database password: ${globals.dbPassword}
    * Public: magnolia.home=${globals.tomcatDataPath}/magnolia/public
    * Author: magnolia.home=${globals.tomcatDataPath}/magnolia/author
    * Authentication username: ${settings.authUsername}
    * Authentication password: ${settings.authPassword}

    ### Magnolia settings
    #### Public:
    Create in your project the following folder:
    '/[project-webapp]/src/main/webapp/WEB-INF/config/${settings.environment}/ROOT/magnolia.properties'
    Add the following properties:
    `magnolia.home=${globals.tomcatDataPath}/magnolia/public`
    ##### DataSource:
    * url: `jdbc:mysql://db:3306/public`
    * user: ${globals.dbUsername}
    * password: ${globals.dbPassword} &successText
    ---
    #### Author:
    Create in your project the following folder:
    '/[project-webapp]/src/main/webapp/WEB-INF/config/${settings.environment}/magnoliaAuthor/magnolia.properties'
    Add the following properties:
    `magnolia.home=${globals.tomcatDataPath}/magnolia/author`
    ##### DataSource:
    Use the following settings for the datasource:
    * url: `jdbc:mysql://db:3306/author`
    * user: ${globals.dbUsername}
    * password: ${globals.dbPassword}