{
  "jpsType": "install",
  "jpsVersion": "0.9",
  "application": {
    "id":"magnolia-cms",
    "name": "Magnolia CMS",
    "version": "0.0.1",
    "logo": "https://github.com/jdiepeveen/jelastic-jps-magnolia-cms/raw/master/images/view.png",
    "type": "java",
    "homepage": "https://github.com/jdiepeveen/jelastic-jps-magnolia-cms",
    "description": "Setup for a basic Magnolia CMS site with Nginx, Tomcat 8.5 and PerconaDB.",
    "categories": [
      "apps/cms"
    ],
    "baseUrl": "https://github.com/jdiepeveen/jelastic-jps-magnolia-cms/raw/master",
    "env": {
      "topology": {
        "ha": false,
        "engine": "java8",
        "ssl": false,
        "nodes": [
          {
            "nodeType": "nginx",
            "count": 1,
            "extip": false,
            "fixedCloudlets": 1,
            "flexibleCloudlets": 4
          },
          {
            "nodeType": "tomcat85",
            "count": 1,
            "extip": false,
            "fixedCloudlets": 1,
            "flexibleCloudlets": 32
          },
          {
            "nodeType": "Percona",
            "count": 1,
            "extip": false,
            "fixedCloudlets": 1,
            "flexibleCloudlets": 16
          }
        ]
      },
      "deployments": [],
      "configs": []
    },
    "onInstall": {
      "call": [
        "setTomcatVariables",
        "removeUnusedWebapps",
        "createDb"
      ]
    },
    "procedures": [
      {
        "id": "setTomcatVariables",
        "onCall": [
          {
            "appendFile": [
              {
                "nodeType": "tomcat85",
                "body": "-Denvironment=${settings.environment}\n-Duser.timezone=Europe/Amsterdam\n",
                "path": "/opt/shared/conf/variables.conf"
              }
            ]
          }
        ]
      },
      {
        "id": "removeUnusedWebapps",
        "onCall": [
          {
            "executeShellCommands": {
              "nodeType": "tomcat85",
              "commands": [
                "rm -rf /opt/shared/webapps/docs",
                "rm -rf /opt/shared/webapps/examples"
              ]
            }
          }
        ]
      },
      {
        "id": "createDb",
        "onCall": [
          {
            "executeShellCommands": {
              "nodeType": "Percona",
              "commands": [
                "curl -fsSL 'https://github.com/jdiepeveen/jelastic-jps-magnolia-cms/raw/master/scripts/createDb.sh' -o /tmp/createDb.sh",
                "/bin/bash -x /tmp/createDb.sh ${nodes.sqldb.password} magnolia ${user.appPassword} 2>&1 1>>/tmp/createDatabase.log",
                "rm /tmp/createDb.sh"
              ]
            }
          }
        ]
      }
    ],
    "settings": {
      "fields": [
        {
          "name": "environment",
          "type": "list",
          "caption": "Enviro nment",
          "values": {
            "test": "Test",
            "acceptance": "Acceptance",
            "production": "Production"
          },
          "default": "test",
          "editable": true,
          "required": true
        },
        {
          "type": "displayfield",
          "caption": "Htaccess"
        },
        {
          "name": "htaccess",
          "type": "radio-fieldset",
          "caption": "Htaccess",
          "values": {
            "enable": "Enable",
            "disable": "Disable"
          },
          "default": "enable",
          "showIf": {
            "enable": [
              {
                "type": "displayfield",
                "caption": "Enter a username and generate a hash from your password. Use e.g. <a href=\"http://www.htpasswdgenerator.net/\" target=\"blank\">http://www.htpasswdgenerator.net/</a>"
              },
              {
                "type": "string",
                "caption": "Usename",
                "name": "htaccess_user"
              },
              {
                "type": "string",
                "caption": "Password",
                "name": "htaccess_password"
              }
            ]
          }
        }
      ]
    },
    "upload": [],
    "success": {
      "text": "Please use the credentials below to gain admin access to your database node:<br><strong>Host:</strong> ${nodes.sqldb.address}<br/><strong>Username:</strong> magnolia<br/><strong>Password:</strong> ${user.appPassword}<br/>",
      "email": "Please use the credentials below to gain admin access to your database node:<br><strong>Host:</strong> ${nodes.sqldb.address}<br/><strong>Username:</strong> magnolia<br/><strong>Password:</strong> ${user.appPassword}<br/>"
    }
  }
}